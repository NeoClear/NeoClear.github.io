<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="analysis of cil &amp; mono infrastructure 1"><meta name="keywords" content="common intermediate language,mono,dotnet core,intermediate representation"><meta name="author" content="NeoClear"><meta name="copyright" content="NeoClear"><title>analysis of cil &amp; mono infrastructure 1 | Star Path</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Why-common-intermediate-language-on-dotnet-virtual-machine"><span class="toc-number">1.</span> <span class="toc-text">Why common intermediate language on dotnet virtual machine</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#why-mono"><span class="toc-number">2.</span> <span class="toc-text">why mono</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#commands"><span class="toc-number">3.</span> <span class="toc-text">commands</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#basic-structure-of-cil-amp-its-runtime"><span class="toc-number">4.</span> <span class="toc-text">basic structure of cil &amp; its runtime</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#translations"><span class="toc-number">5.</span> <span class="toc-text">translations</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hello-World"><span class="toc-number">5.1.</span> <span class="toc-text">Hello World</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Local-Variables"><span class="toc-number">5.2.</span> <span class="toc-text">Local Variables</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Primitive-Types-amp-Their-Representation-in-local-variable"><span class="toc-number">5.3.</span> <span class="toc-text">Primitive Types &amp; Their Representation in local variable</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#load-a-const-int32-to-stack-top"><span class="toc-number">5.3.1.</span> <span class="toc-text">load a const int32 to stack top</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Load-local-variable"><span class="toc-number">5.3.2.</span> <span class="toc-text">Load local variable</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Access-method-arguments-amp-control-flow"><span class="toc-number">5.4.</span> <span class="toc-text">Access method arguments &amp; control flow</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#new-instructions-in-this-part"><span class="toc-number">5.4.1.</span> <span class="toc-text">new instructions in this part</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Generate-new-array-amp-control-flow"><span class="toc-number">5.5.</span> <span class="toc-text">Generate new array &amp; control flow</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#new-instruction-of-this-example"><span class="toc-number">5.5.1.</span> <span class="toc-text">new instruction of this example</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#customized-cil-codes"><span class="toc-number">5.6.</span> <span class="toc-text">customized cil codes</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">NeoClear</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">72</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">73</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">6</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Star Path</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">analysis of cil &amp; mono infrastructure 1</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-01-05</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/common-intermediate-language/">common intermediate language</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>let’s start our microsoft common intermediate language journey</p>
<h2 id="Why-common-intermediate-language-on-dotnet-virtual-machine"><a href="#Why-common-intermediate-language-on-dotnet-virtual-machine" class="headerlink" title="Why common intermediate language on dotnet virtual machine"></a>Why common intermediate language on dotnet virtual machine</h2><ul>
<li>compared to llvm, better tool chain (driven by microsoft)</li>
<li>compared to jvm, better documentation (driven by microsoft)</li>
<li>easy to understand</li>
<li>cross platform</li>
<li>microsoft means easy to use &amp; good quality (yes I’m ms dog)</li>
</ul>
<a id="more"></a>

<h2 id="why-mono"><a href="#why-mono" class="headerlink" title="why mono"></a>why mono</h2><ul>
<li>mono is an implementation of dotnet core &amp; it is sponsored by microsoft. It is a better choice if you want to deploy your project to other platforms</li>
<li>implement all tools in dotnet core</li>
<li>install through choco in windows, and package manager in other platforms</li>
</ul>
<h2 id="commands"><a href="#commands" class="headerlink" title="commands"></a>commands</h2><ul>
<li>ilasm: compile cil source code into executable program</li>
<li>mono: run executable code under all platforms</li>
<li>monodis: disassemble executable program into corresponding cil, alternative of <strong>ildasm</strong> (use –output=file to specify output file)</li>
<li>mcs: compile csharp code into executable code</li>
</ul>
<h2 id="basic-structure-of-cil-amp-its-runtime"><a href="#basic-structure-of-cil-amp-its-runtime" class="headerlink" title="basic structure of cil &amp; its runtime"></a>basic structure of cil &amp; its runtime</h2><p>like jvm bytecode assembly, microsoft dotnet cil is based on stack. All operations are carried out through stack operations</p>
<h2 id="translations"><a href="#translations" class="headerlink" title="translations"></a>translations</h2><h3 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Test</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">        System.Console.WriteLine(<span class="string">"Hello World!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.assembly ConsoleApp&#123;&#125;</span><br><span class="line"></span><br><span class="line">.method public static void Main()  </span><br><span class="line">&#123;  </span><br><span class="line">    .entrypoint</span><br><span class="line">    ldstr &quot;hello world!&quot;</span><br><span class="line">    call void [mscorlib]System.Console::WriteLine(string)</span><br><span class="line">    ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>.entrypoint denotes the entry of the whole program. In order to get the program work, .assembly ConsoleApp{} must be included at the front of the cil source file</p>
<p>ldstr pushes the reference of static string to stack top. Then a function in standard lib is called given stack top as its argument. Finally, ret returns the function</p>
<p>If the parameter of System.Console.WriteLine is changed to int32, then the code would be</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldc.i4 2333</span><br><span class="line">call void [mscorlib]System.Console::WriteLine(int32)</span><br></pre></td></tr></table></figure>

<h3 id="Local-Variables"><a href="#Local-Variables" class="headerlink" title="Local Variables"></a>Local Variables</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Test</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">int</span> b = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">int</span> c = a + b;</span><br><span class="line">        System.Console.WriteLine(c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.assembly ConsoleApp&#123;&#125;</span><br><span class="line"></span><br><span class="line">.method public static void Main()  </span><br><span class="line">&#123;  </span><br><span class="line">    .entrypoint</span><br><span class="line">    .locals init (</span><br><span class="line">        int32   V_0,</span><br><span class="line">        int32   V_1,</span><br><span class="line">        int32   V_2</span><br><span class="line">    )</span><br><span class="line">    ldc.i4.2</span><br><span class="line">    stloc.0</span><br><span class="line">    ldc.i4.3</span><br><span class="line">    stloc.1</span><br><span class="line">    ldloc.0</span><br><span class="line">    ldloc.1</span><br><span class="line">    add</span><br><span class="line">    stloc.2</span><br><span class="line">    ldloc.2</span><br><span class="line">    call void [mscorlib]System.Console::WriteLine(int32)</span><br><span class="line">    ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The new thing here is local variable. If you have read csapp, you will know that x86 assembly language actually stores local variables in registers or at the bottom of current stack frame. In cil, local variables are stored in a table. It is simpler, but who knows how microsoft staffs implement this functionality</p>
<p>.locals init creates local variable table, and stloc.i stores stack top to local variable indexed i, ldloc.i load ith local variable to stack top</p>
<h3 id="Primitive-Types-amp-Their-Representation-in-local-variable"><a href="#Primitive-Types-amp-Their-Representation-in-local-variable" class="headerlink" title="Primitive Types &amp; Their Representation in local variable"></a>Primitive Types &amp; Their Representation in local variable</h3><p>When specifying type in cil, different notation is used</p>
<ul>
<li>int -&gt; int32</li>
<li>string -&gt; string</li>
<li>float -&gt; float32</li>
<li>char -&gt; char</li>
<li>bool -&gt; bool</li>
</ul>
<h4 id="load-a-const-int32-to-stack-top"><a href="#load-a-const-int32-to-stack-top" class="headerlink" title="load a const int32 to stack top"></a>load a const int32 to stack top</h4><p>if the load value is within [0, 8] or is -1, a simpler &amp; faster instruction can be used</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ldc.i4.0</span><br><span class="line">ldc.i4.8</span><br><span class="line">ldc.i4.M1</span><br></pre></td></tr></table></figure>

<p>If the value exceedes it, you have to use short format</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldc.i4.s 532235</span><br></pre></td></tr></table></figure>

<h4 id="Load-local-variable"><a href="#Load-local-variable" class="headerlink" title="Load local variable"></a>Load local variable</h4><p>If you want to load local variable to stack top and within [0, 3], then you can just use</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldloc.0</span><br><span class="line">ldloc.3</span><br></pre></td></tr></table></figure>

<p>If the index exceedes 3, use short format instead</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldloc.s 42</span><br></pre></td></tr></table></figure>

<h3 id="Access-method-arguments-amp-control-flow"><a href="#Access-method-arguments-amp-control-flow" class="headerlink" title="Access method arguments &amp; control flow"></a>Access method arguments &amp; control flow</h3><p>We have a piece of code that accesses its arguments</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Test</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">string</span> it <span class="keyword">in</span> args)</span><br><span class="line">            System.Console.WriteLine(it);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">.assembly ConsoleApp&#123;&#125;</span><br><span class="line"></span><br><span class="line">.method public static void Main (string[] args)</span><br><span class="line">&#123;</span><br><span class="line">	.entrypoint</span><br><span class="line">	.locals init (</span><br><span class="line">		string	V_99,</span><br><span class="line">		string[]	V_1,</span><br><span class="line">		int32	V_2</span><br><span class="line">	)</span><br><span class="line">    // load the first argument to stack top</span><br><span class="line">	IL_0000:  ldarg.0 </span><br><span class="line">	IL_0001:  stloc.1 </span><br><span class="line">	IL_0002:  ldc.i4.0 </span><br><span class="line">	IL_0003:  stloc.2</span><br><span class="line"></span><br><span class="line">    // jump to the label</span><br><span class="line">	IL_0004:  br IL_0017</span><br><span class="line"></span><br><span class="line">	IL_0009:  ldloc.1</span><br><span class="line">	IL_000a:  ldloc.2</span><br><span class="line">    // load the reference of given array at given index to stack top</span><br><span class="line">	IL_000b:  ldelem.ref </span><br><span class="line">	IL_000c:  stloc.0</span><br><span class="line">	IL_000d:  ldloc.0</span><br><span class="line">	IL_000e:  call void class [mscorlib]System.Console::WriteLine(string)</span><br><span class="line">	IL_0013:  ldloc.2</span><br><span class="line">	IL_0014:  ldc.i4.1</span><br><span class="line">	IL_0015:  add</span><br><span class="line">	IL_0016:  stloc.2</span><br><span class="line">	IL_0017:  ldloc.2</span><br><span class="line">	IL_0018:  ldloc.1</span><br><span class="line">    // load the length of stack top array to stack top</span><br><span class="line">	IL_0019:  ldlen</span><br><span class="line">    // change the stack top to int32</span><br><span class="line">	IL_001a:  conv.i4</span><br><span class="line">    // if the first is smaller than the second, jump to target</span><br><span class="line">	blt IL_0009</span><br><span class="line"></span><br><span class="line">	ret </span><br><span class="line">&#125; // end of method Test::Main</span><br></pre></td></tr></table></figure>

<h4 id="new-instructions-in-this-part"><a href="#new-instructions-in-this-part" class="headerlink" title="new instructions in this part"></a>new instructions in this part</h4><ul>
<li><p>ldarg<br>if index is within [0, 3], just use <strong>ldarg.0</strong> to load arguments<br>if exceeds, use <strong>ldarg.S 432</strong> instead</p>
</li>
<li><p>br<br>jump to label</p>
</li>
<li><p>ldelem.ref<br>load the element of array given index to stack top as a reference</p>
</li>
<li><p>ldlen<br>load the length of given array to stack top</p>
</li>
<li><p>conv.i4<br>convert to int32</p>
</li>
<li><p>blt<br>jump to label if the first is less than the second</p>
</li>
</ul>
<h3 id="Generate-new-array-amp-control-flow"><a href="#Generate-new-array-amp-control-flow" class="headerlink" title="Generate new array &amp; control flow"></a>Generate new array &amp; control flow</h3><p>I have the code:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Test</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">int</span>[] lst = &#123;<span class="number">0</span>, <span class="number">1</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">            System.Console.WriteLine(lst[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The corresponding cil code is</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">.assembly	ConsoleApp&#123;&#125;</span><br><span class="line"></span><br><span class="line">.method public static void Main (string[] args) &#123;</span><br><span class="line">	.entrypoint</span><br><span class="line">	.locals init (</span><br><span class="line">		int32[]	V_0,</span><br><span class="line">		int32	V_1</span><br><span class="line">	)</span><br><span class="line">	IL_0000:  ldc.i4.2</span><br><span class="line">	IL_0001:  newarr [mscorlib]System.Int32</span><br><span class="line">	IL_0006:  dup</span><br><span class="line">	IL_0007:  ldc.i4.1</span><br><span class="line">	IL_0008:  ldc.i4.1</span><br><span class="line">	IL_0009:  stelem.i4</span><br><span class="line">	IL_000a:  stloc.0</span><br><span class="line">	IL_000b:  ldc.i4.0</span><br><span class="line">	IL_000c:  stloc.1 </span><br><span class="line">	IL_000d:  br IL_001e</span><br><span class="line"></span><br><span class="line">	IL_0012:  ldloc.0 </span><br><span class="line">	IL_0013:  ldloc.1 </span><br><span class="line">	IL_0014:  ldelem.i4 </span><br><span class="line">	IL_0015:  call void class [mscorlib]System.Console::WriteLine(int32)</span><br><span class="line">	IL_001a:  ldloc.1 </span><br><span class="line">	IL_001b:  ldc.i4.1 </span><br><span class="line">	IL_001c:  add </span><br><span class="line">	IL_001d:  stloc.1 </span><br><span class="line">	IL_001e:  ldloc.1 </span><br><span class="line">	IL_001f:  ldc.i4.2 </span><br><span class="line">	IL_0020:  blt IL_0012</span><br><span class="line"></span><br><span class="line">	IL_0025:  ret </span><br><span class="line">&#125; // end of method Test::Main</span><br></pre></td></tr></table></figure>

<h4 id="new-instruction-of-this-example"><a href="#new-instruction-of-this-example" class="headerlink" title="new instruction of this example"></a>new instruction of this example</h4><ul>
<li><p>newarr<br>create a new array and pushes its addr to stack top given array size</p>
</li>
<li><p>dup<br>copy the stack top</p>
</li>
</ul>
<h3 id="customized-cil-codes"><a href="#customized-cil-codes" class="headerlink" title="customized cil codes"></a>customized cil codes</h3><p>This is a code that generates a int[] = {0, 3, 1} and print arr.getIndex(i) times “Hello World”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">.method public static void main(string[] args) &#123;</span><br><span class="line">    .entrypoint</span><br><span class="line">    .locals init (</span><br><span class="line">        string  V_0,</span><br><span class="line">        int32[] V_1,</span><br><span class="line">        int32   V_2</span><br><span class="line">    )</span><br><span class="line">    ldstr   &quot;hello world!&quot;</span><br><span class="line">    stloc.0</span><br><span class="line">    ldc.i4.0</span><br><span class="line">    stloc.2</span><br><span class="line"></span><br><span class="line">    ldc.i4.3</span><br><span class="line">    newarr [mscorlib]System.Int32</span><br><span class="line">    stloc.1</span><br><span class="line">    ldloc.1</span><br><span class="line">    ldc.i4.1</span><br><span class="line">    ldc.i4.3</span><br><span class="line">    stelem.i4</span><br><span class="line">    ldloc.1</span><br><span class="line">    ldc.i4.2</span><br><span class="line">    ldc.i4.1</span><br><span class="line">    stelem.i4</span><br><span class="line">    IL_0000:    br IL_0002</span><br><span class="line"></span><br><span class="line">    IL_0001:    ldloc.0</span><br><span class="line">    ldloc.1</span><br><span class="line">    ldloc.2</span><br><span class="line">    ldelem.i4</span><br><span class="line">    call void print(string, int32)</span><br><span class="line">    ldc.i4.0</span><br><span class="line">    call void [mscorlib]System.Console::WriteLine(int32)</span><br><span class="line"></span><br><span class="line">    ldloc.2</span><br><span class="line">    ldc.i4.1</span><br><span class="line">    add</span><br><span class="line">    stloc.2</span><br><span class="line"></span><br><span class="line">    IL_0002:    ldloc.2</span><br><span class="line">    ldc.i4.3</span><br><span class="line">    blt IL_0001</span><br><span class="line"></span><br><span class="line">    ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This piece of code shows how arrays are stored in the actual code. Array is just a reference, and after modifying its elements, you do not need to store its value back to local variable table</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">NeoClear</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://neoclear.github.io/2020/01/05/dotnet/analysis-of-cil-mono-infrastructure-1/">http://neoclear.github.io/2020/01/05/dotnet/analysis-of-cil-mono-infrastructure-1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/common-intermediate-language/">common intermediate language</a><a class="post-meta__tags" href="/tags/mono/">mono</a><a class="post-meta__tags" href="/tags/dotnet-core/">dotnet core</a><a class="post-meta__tags" href="/tags/intermediate-representation/">intermediate representation</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/01/08/dotnet/analysis-of-cil-mono-infrastructure-2/"><i class="fa fa-chevron-left">  </i><span>analysis of cil mono infrastructure 2</span></a></div><div class="next-post pull-right"><a href="/2020/01/05/leetcode/leetcode-weekly-contest-170/"><span>leetcode weekly contest 170</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By NeoClear</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>